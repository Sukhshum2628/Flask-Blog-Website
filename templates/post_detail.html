{% extends 'base.html' %}

{% block head %}
<style>
    .progress-container {
        position: fixed;
        top: 0;
        z-index: 2000;
        width: 100%;
        height: 4px;
        background: transparent;
    }
    .progress-bar {
        height: 4px;
        background: #198754;
        width: 0%;
        transition: width 0.1s;
    }
</style>
{% endblock %}

{% block content %}
<div class="progress-container">
    <div class="progress-bar" id="myBar"></div>
</div>
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Post Header -->
        <article>
            <h1 class="fw-bold mb-3 mt-4">
                {% if post.is_draft %}
                    <span class="badge bg-secondary fs-6 align-middle me-2">DRAFT</span>
                {% endif %}
                {{ post.title }}
            </h1>
            {% if post.subtitle %}
                <h4 class="text-muted mb-4">{{ post.subtitle }}</h4>
            {% endif %}

            <div class="d-flex align-items-center mb-4">
                <img src="{{ author.avatar_url or 'https://ui-avatars.com/api/?name=' + post.author }}" 
                     alt="{{ post.author }}" class="rounded-circle me-3" width="48" height="48">
                <div>
                    <div class="fw-bold">
                        <a href="{{ url_for('profile', username=post.author) }}" class="text-decoration-none text-dark">{{ post.author }}</a>
                    </div>
                    <div class="text-muted small">
                        {{ post.created_at.strftime('%b %d, %Y') if post.created_at else '' }} · {{ read_time }} min read
                        {% if active_readers > 1 %}
                            · <span class="text-success fw-bold"><i class="bi bi-people-fill"></i> {{ active_readers }} people reading now</span>
                        {% endif %}
                        {% if is_author %}
                            · <a href="{{ url_for('edit_post', post_id=post._id) }}" class="text-secondary">Edit</a>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="post-content fs-5 serif-font">
                {% if post.cover_url %}
                    <figure class="mb-4" data-aos="fade-in">
                        <img src="{{ post.cover_url }}" class="img-fluid rounded w-100" alt="Cover Image">
                    </figure>
                {% endif %}
                {{ post.content|safe }}
            </div>

            <div class="mt-5 mb-4">
                {% for tag in post.tags|default([]) %}
                    <a href="{{ url_for('search', q=tag) }}" class="badge bg-light text-dark text-decoration-none border fw-normal p-2 me-1">{{ tag }}</a>
                {% endfor %}
            </div>
        </article>
        
        <hr class="my-5">

        <!-- Interaction -->
        <div class="d-flex justify-content-between align-items-center mb-5">
            <div>
                <a href="{{ url_for('like_post', post_id=post._id) }}" class="btn {{ 'btn-dark' if has_liked else 'btn-outline-dark' }} rounded-pill me-2">
                    <i class="bi bi-hand-thumbs-up-fill"></i> Claps <span class="badge bg-light text-dark ms-1">{{ post.likes|default([])|length }}</span>
                </a>
                
                <a href="{{ url_for('bookmark_post', post_id=post._id) }}" class="btn {{ 'btn-dark' if is_bookmarked else 'btn-outline-secondary' }} rounded-pill" title="{{ 'Remove from Reading List' if is_bookmarked else 'Save to Reading List' }}">
                    <i class="bi {{ 'bi-bookmark-fill' if is_bookmarked else 'bi-bookmark' }}"></i>
                </a>
            </div>
            <!-- Share buttons could go here -->
        </div>

        <!-- Series Navigation -->
        {% if post.series_name %}
        <div class="card bg-light border-0 mb-5">
            <div class="card-body">
                <h6 class="text-uppercase text-muted small fw-bold mb-3">More in this series: {{ post.series_name }}</h6>
                <div class="row">
                    <div class="col-6">
                        {% if series_prev %}
                            <a href="{{ url_for('view_post', post_id=series_prev._id) }}" class="text-decoration-none text-dark d-block">
                                <small class="text-muted">Previous</small>
                                <div class="fw-bold">{{ series_prev.title }}</div>
                            </a>
                        {% else %}
                            <span class="text-muted opacity-50"><small>Previous</small><br>Start of series</span>
                        {% endif %}
                    </div>
                    <div class="col-6 text-end">
                        {% if series_next %}
                            <a href="{{ url_for('view_post', post_id=series_next._id) }}" class="text-decoration-none text-dark d-block">
                                <small class="text-muted">Next</small>
                                <div class="fw-bold">{{ series_next.title }}</div>
                            </a>
                        {% else %}
                            <span class="text-muted opacity-50"><small>Next</small><br>Waiting for next part</span>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Comments Section -->
        <section>
            <h4 class="mb-4">Responses ({{ comments|length }})</h4>
            
            {% if session.user %}
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-body">
                        <form method="POST">
                            {{ form.hidden_tag() }}
                            <div class="mb-3">
                                {{ form.content(class="form-control", rows=3, placeholder="What are your thoughts?") }}
                            </div>
                            <div class="text-end">
                                {{ form.submit(class="btn btn-success rounded-pill px-4") }}
                            </div>
                        </form>
                    </div>
                </div>
            {% else %}
                <p class="text-muted border p-3 rounded"><a href="{{ url_for('login') }}">Sign in</a> to leave a response.</p>
            {% endif %}

            {% for comment in comments %}
                <div class="d-flex mb-4">
                    <div class="flex-shrink-0">
                        <img src="https://ui-avatars.com/api/?name={{ comment.author }}&background=random" 
                             class="rounded-circle" width="40" height="40" alt="{{ comment.author }}">
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="mb-1">
                            <span class="fw-bold">{{ comment.author }}</span>
                            <small class="text-muted ms-2">{{ comment.created_at.strftime('%b %d') if comment.created_at else '' }}</small>
                        </div>
                        <p class="mb-0">{{ comment.content }}</p>
                    </div>
                </div>
            {% endfor %}
        </section>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Toast for Progress Memory -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
  <div id="progressToast" class="toast align-items-center text-bg-dark border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        Welcome back! We've taken you to where you left off.
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>

<script>
    const postId = "{{ post._id }}";
    const storageKey = "read_progress_" + postId;
    
    // Existing Progress Bar
    window.onscroll = function() { 
        updateProgressBar();
        saveProgress();
    };

    function updateProgressBar() {
        var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        var height = document.documentElement.scrollHeight - document.documentElement.clientHeight;
        var scrolled = (winScroll / height) * 100;
        document.getElementById("myBar").style.width = scrolled + "%";
    }

    // New: Save/Restore Progress
    function saveProgress() {
        // Debounce or just save
        var winScroll = document.body.scrollTop || document.documentElement.scrollTop;
        localStorage.setItem(storageKey, winScroll);
    }

    document.addEventListener("DOMContentLoaded", function() {
        const savedPosition = localStorage.getItem(storageKey);
        if (savedPosition && parseInt(savedPosition) > 100) {
            window.scrollTo({
                top: parseInt(savedPosition),
                behavior: 'smooth'
            });
            
            // Show toast
            const toastEl = document.getElementById('progressToast');
            const toast = new bootstrap.Toast(toastEl);
            toast.show();
        }
    });
</script>
{% endblock %}
